<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDF MASTER - ×”××¢×¨×›×ª ×”××œ××”</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://unpkg.com/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
    <script src="https://unpkg.com/@pdf-lib/fontkit/dist/fontkit.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.14.0/Sortable.min.js"></script>

    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    </script>

    <style>
        :root {
            --primary: #2563eb;
            --secondary: #1e40af;
            --bg: #f8fafc;
            --card: #ffffff;
            --text: #0f172a;
            --border: #e2e8f0;
            --delete: #ef4444;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg);
            color: var(--text);
            margin: 0;
            padding: 20px;
            direction: rtl;
        }

        .container { max-width: 1200px; margin: 0 auto; }
        h1 { text-align: center; color: var(--primary); margin-bottom: 20px; text-transform: uppercase; letter-spacing: 1px; }

        /* ×ª×¤×¨×™×˜ ×¨××©×™ */
        .nav-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(110px, 1fr));
            gap: 10px;
            margin-bottom: 25px;
        }

        .nav-btn {
            background: white;
            border: 1px solid var(--border);
            padding: 12px;
            text-align: center;
            border-radius: 10px;
            cursor: pointer;
            font-size: 0.9em;
            font-weight: 600;
            transition: all 0.2s;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.02);
        }

        .nav-btn span { font-size: 1.4em; }
        .nav-btn:hover { border-color: var(--primary); transform: translateY(-2px); }
        .nav-btn.active { background: var(--primary); color: white; border-color: var(--primary); box-shadow: 0 4px 10px rgba(37, 99, 235, 0.3); }

        /* × ×™×”×•×œ ×§×‘×¦×™× */
        .file-manager {
            background: white;
            border: 2px dashed #94a3b8;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .file-list {
            list-style: none;
            padding: 0;
            margin: 15px 0 0 0;
            max-height: 200px;
            overflow-y: auto;
        }

        .file-item {
            background: #f1f5f9;
            border: 1px solid var(--border);
            margin-bottom: 8px;
            padding: 10px 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-radius: 8px;
            cursor: move;
        }

        .btn-add {
            background: #10b981;
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            display: inline-block;
        }

        /* ×¢×•×¨×š ×•×™×–×•××œ×™ */
        .visual-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 15px;
            margin-top: 20px;
            padding: 15px;
            background: #f1f5f9;
            border-radius: 10px;
            min-height: 200px;
        }

        .page-thumb {
            background: white;
            border: 2px solid transparent;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            cursor: pointer;
            position: relative;
            transition: all 0.2s;
            border-radius: 4px;
            overflow: hidden;
        }

        .page-thumb canvas { width: 100%; display: block; }
        
        .page-thumb.selected {
            border-color: var(--delete);
            opacity: 0.7;
            transform: scale(0.95);
        }
        .page-thumb.selected::after {
            content: 'ğŸ—‘ï¸';
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            font-size: 2em;
        }

        .page-number {
            position: absolute;
            bottom: 5px; right: 5px;
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.8em;
        }

        /* ××–×•×¨×™ ×¢×‘×•×“×” */
        .workspace { display: none; background: white; padding: 25px; border-radius: 16px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        .workspace.active { display: block; }

        .info-bar {
            background: #eff6ff;
            color: #1e40af;
            padding: 10px 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 0.9em;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 1px solid #bfdbfe;
        }

        /* ×¤×§×“×™× */
        .controls { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 15px; }
        .control-group { display: flex; flex-direction: column; gap: 5px; }
        
        label { font-weight: 600; font-size: 0.9em; color: #475569; }
        input, select { padding: 10px; border: 1px solid var(--border); border-radius: 8px; font-size: 1em; }

        .btn-action {
            width: 100%;
            padding: 15px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 1.1em;
            font-weight: bold;
            cursor: pointer;
            transition: 0.2s;
            margin-top: 10px;
        }
        .btn-action:hover { background: #1d4ed8; }
        .btn-danger { background: var(--delete); }
        .btn-danger:hover { background: #dc2626; }

        /* ×¡×˜×˜×•×¡ ×•×¤×•× ×˜×™× */
        .font-alert {
            background: #fffbeb;
            border: 1px solid #fcd34d;
            padding: 12px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.9em;
        }

        .status-msg {
            margin-top: 20px;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            font-weight: bold;
            display: none;
        }
        .status-msg.loading { background: #e0f2fe; color: #0369a1; }
        .status-msg.success { background: #dcfce7; color: #166534; }
        .status-msg.error { background: #fee2e2; color: #991b1b; }

    </style>
</head>
<body>

<div class="container">
    <h1>PDF PRO MAX ğŸš€</h1>

    <div class="nav-grid">
        <div class="nav-btn active" onclick="switchTab('visual')"><span>ğŸ‘ï¸</span>×¢×¨×™×›×” ×•×™×–×•××œ×™×ª</div>
        <div class="nav-btn" onclick="switchTab('merge')"><span>ğŸ”—</span>××™×—×•×“</div>
        <div class="nav-btn" onclick="switchTab('split')"><span>âœ‚ï¸</span>×¤×™×¦×•×œ (ZIP)</div>
        <div class="nav-btn" onclick="switchTab('text')"><span>âœï¸</span>×˜×§×¡×˜</div>
        <div class="nav-btn" onclick="switchTab('watermark')"><span>ğŸ’§</span>×—×•×ª××ª</div>
        <div class="nav-btn" onclick="switchTab('pagenum')"><span>ğŸ”¢</span>××¡×¤×•×¨</div>
        <div class="nav-btn" onclick="switchTab('convert')"><span>ğŸ–¼ï¸</span>×œ-×ª××•× ×•×ª</div>
        <div class="nav-btn" onclick="switchTab('img2pdf')"><span>ğŸ“·</span>×ª××•× ×” ×œ-PDF</div>
        <div class="nav-btn" onclick="switchTab('protect')"><span>ğŸ”’</span>×”×¦×¤× ×”</div>
        <div class="nav-btn" onclick="switchTab('bw')"><span>âš«</span>×©×—×•×¨ ×œ×‘×Ÿ</div>
    </div>

    <div class="file-manager">
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <div>
                <h3>ğŸ“‚ ×¨×©×™××ª ×§×‘×¦×™×</h3>
                <small style="color:#64748b">×’×¨×•×¨ ×œ×©×™× ×•×™ ×¡×“×¨ | × ×™×ª×Ÿ ×œ×”×•×¡×™×£ ×¢×•×“ ×§×‘×¦×™× ×‘×›×œ ×¨×’×¢</small>
            </div>
            <label class="btn-add">
                + ×”×•×¡×£ ×§×‘×¦×™×
                <input type="file" multiple accept=".pdf,.jpg,.png,.jpeg" style="display:none" onchange="addFiles(this)">
            </label>
        </div>
        <ul id="file-list" class="file-list">
            <li style="text-align:center; color:#94a3b8; padding:20px;">×”×¨×©×™××” ×¨×™×§×”... ×”×•×¡×£ ×§×‘×¦×™× ×›×“×™ ×œ×”×ª×—×™×œ</li>
        </ul>
        <button onclick="clearFiles()" style="color:#ef4444; background:none; border:none; cursor:pointer; margin-top:10px; font-weight:bold;">ğŸ—‘ï¸ × ×§×” ×”×›×œ</button>
    </div>

    <div class="font-alert">
        <div>
            <b>âš ï¸ ×—×•×‘×” ×œ×¢×‘×¨×™×ª!</b> ×œ×× ×™×¢×ª ×’'×™×‘×¨×™×©, ×˜×¢×Ÿ ×§×•×‘×¥ ×¤×•× ×˜ (×›××• Arial.ttf) ××”××—×©×‘.
        </div>
        <div>
            <input type="file" accept=".ttf,.otf" onchange="loadFont(this)">
            <span id="font-status" style="margin-right:8px; font-weight:bold; color:#ef4444;">×œ× × ×˜×¢×Ÿ</span>
        </div>
    </div>

    <div id="tab-visual" class="workspace active">
        <div class="info-bar" id="info-visual">×˜×¢×Ÿ ×§×•×‘×¥ PDF ×›×“×™ ×œ×¨××•×ª ××ª ×”×¢××•×“×™×</div>
        <h2>×¢×¨×™×›×” ×•×™×–×•××œ×™×ª: ××—×™×§×” ×•×¡×™×“×•×¨ ××—×“×©</h2>
        <p>×œ×—×¥ ×¢×œ ×¢××•×“ ×›×“×™ ×œ×¡××Ÿ ××•×ª×• ×œ××—×™×§×” (××“×•×), ××• ×’×¨×•×¨ ×›×“×™ ×œ×©× ×•×ª ×¡×“×¨.</p>
        
        <div class="controls">
            <button class="btn-action" onclick="loadVisualEditor()">ğŸ”„ ×˜×¢×Ÿ ×ª×¦×•×’×” ××§×“×™××”</button>
            <button class="btn-action btn-danger" onclick="deleteSelectedPages()">ğŸ—‘ï¸ ××—×§ ×¢××•×“×™× ××¡×•×× ×™×</button>
            <button class="btn-action" onclick="saveVisualChanges()" style="background:#059669;">ğŸ’¾ ×©××•×¨ ×§×•×‘×¥ ×—×“×©</button>
        </div>
        
        <div id="visual-grid" class="visual-grid"></div>
    </div>

    <div id="tab-merge" class="workspace">
        <div class="info-bar">×××ª×™×Ÿ ×œ××™×—×•×“ ×›×œ ×”×§×‘×¦×™× ×‘×¨×©×™××”</div>
        <h2>××™×—×•×“ ×§×‘×¦×™× (PDF + ×ª××•× ×•×ª)</h2>
        <p>×”×§×‘×¦×™× ×™×—×•×‘×¨×• ×œ×¤×™ ×”×¡×“×¨ ×©×§×‘×¢×ª ×‘×¨×©×™××” ×œ××¢×œ×”.</p>
        <button class="btn-action" onclick="runMerge()">×‘×¦×¢ ××™×—×•×“ ×•×”×•×¨×“</button>
    </div>

    <div id="tab-split" class="workspace">
        <div class="info-bar" id="info-split">×‘×—×¨ ×§×•×‘×¥...</div>
        <h2>×¤×™×¦×•×œ PDF</h2>
        <div class="controls">
            <div class="control-group">
                <label>××¦×‘:</label>
                <select id="split-mode" onchange="document.getElementById('range-box').style.display = this.value==='range'?'block':'none'">
                    <option value="zip">×¤×¦×œ ×”×›×œ ×œ-ZIP (×›×œ ×¢××•×“ ×‘× ×¤×¨×“)</option>
                    <option value="range">×©××•×¨ ×˜×•×•×— ×¢××•×“×™× (×—×™×œ×•×¥)</option>
                </select>
            </div>
            <div class="control-group" id="range-box" style="display:none;">
                <label>×˜×•×•×— (×œ××©×œ 1-5):</label>
                <input type="text" id="split-range" placeholder="1-5">
            </div>
        </div>
        <button class="btn-action" onclick="runSplit()">×‘×¦×¢</button>
    </div>

    <div id="tab-text" class="workspace">
        <div class="info-bar" id="info-text">×‘×—×¨ ×§×•×‘×¥...</div>
        <h2>×”×•×¡×¤×ª ×˜×§×¡×˜</h2>
        <div class="controls">
            <div class="control-group">
                <label>×˜×§×¡×˜:</label>
                <input type="text" id="txt-val" placeholder="×”×›× ×¡ ×˜×§×¡×˜">
            </div>
            <div class="control-group">
                <label>×’×•×“×œ:</label>
                <input type="number" id="txt-size" value="24">
            </div>
            <div class="control-group">
                <label>×¦×‘×¢:</label>
                <input type="color" id="txt-color" value="#000000" style="height:45px;">
            </div>
            <div class="control-group">
                <label>××™×§×•×:</label>
                <select id="txt-pos">
                    <option value="top-right">×œ××¢×œ×” ××™××™×Ÿ</option>
                    <option value="top-left">×œ××¢×œ×” ××©×××œ</option>
                    <option value="center">××¨×›×–</option>
                    <option value="bottom">×œ××˜×”</option>
                </select>
            </div>
        </div>
        <button class="btn-action" onclick="runAddText()">×”×•×¡×£ ×˜×§×¡×˜</button>
    </div>

    <div id="tab-watermark" class="workspace">
        <div class="info-bar" id="info-watermark">×‘×—×¨ ×§×•×‘×¥...</div>
        <h2>×—×•×ª××ª ××™× ××ª×§×“××ª</h2>
        <div class="controls">
            <div class="control-group">
                <label>×˜×§×¡×˜:</label>
                <input type="text" id="wm-text" placeholder="×˜×™×•×˜×”">
            </div>
            <div class="control-group">
                <label>×–×•×•×™×ª (45 ×œ××œ×›×¡×•×Ÿ):</label>
                <input type="number" id="wm-angle" value="45">
            </div>
            <div class="control-group">
                <label>×©×§×™×¤×•×ª (0-1):</label>
                <input type="number" id="wm-op" value="0.3" step="0.1" max="1">
            </div>
            <div class="control-group">
                <label>×’×•×“×œ:</label>
                <input type="number" id="wm-size" value="60">
            </div>
            <div class="control-group">
                <label>×¦×‘×¢:</label>
                <input type="color" id="wm-color" value="#999999" style="height:45px;">
            </div>
        </div>
        <button class="btn-action" onclick="runWatermark()">×”×•×¡×£ ×—×•×ª××ª</button>
    </div>

    <div id="tab-pagenum" class="workspace">
        <div class="info-bar" id="info-pagenum">×‘×—×¨ ×§×•×‘×¥...</div>
        <h2>××¡×¤×•×¨ ×¢××•×“×™×</h2>
        <div class="controls">
            <div class="control-group">
                <label>×¤×•×¨××˜:</label>
                <select id="pg-fmt">
                    <option value="num">1, 2, 3</option>
                    <option value="heb">×¢××•×“ 1 ××ª×•×š 10</option>
                    <option value="eng">Page 1 of 10</option>
                </select>
            </div>
            <div class="control-group">
                <label>××™×§×•×:</label>
                <select id="pg-pos">
                    <option value="bottom">×œ××˜×” ×‘×××¦×¢</option>
                    <option value="top">×œ××¢×œ×” ×‘×××¦×¢</option>
                    <option value="bottom-side">×œ××˜×” ×‘×¦×“</option>
                </select>
            </div>
            <div class="control-group">
                <label>×¦×‘×¢:</label>
                <input type="color" id="pg-color" value="#000000" style="height:45px;">
            </div>
        </div>
        <button class="btn-action" onclick="runPageNum()">×”×•×¡×£ ××¡×¤×•×¨</button>
    </div>

    <div id="tab-convert" class="workspace">
        <div class="info-bar" id="info-convert">×‘×—×¨ ×§×•×‘×¥...</div>
        <h2>×”××¨×” ×œ×ª××•× ×•×ª (ZIP)</h2>
        <p>×”×•×¤×š ×›×œ ×“×£ ×œ×ª××•× ×” ×•×©×•××¨ ×‘×ª×™×§×™×™×” ××›×•×•×¦×ª.</p>
        <div class="controls">
            <div class="control-group">
                <label>×¤×•×¨××˜:</label>
                <select id="conv-fmt">
                    <option value="jpeg">JPEG (×§×‘×¦×™× ×§×˜× ×™×)</option>
                    <option value="png">PNG (××™×›×•×ª ×’×‘×•×”×”)</option>
                </select>
            </div>
        </div>
        <button class="btn-action" onclick="runConvertToImages()">×”××¨ ×•×”×•×¨×“</button>
    </div>

    <div id="tab-img2pdf" class="workspace">
        <div class="info-bar">×§×•×‘×¥ 1: PDF, ×§×•×‘×¥ 2: ×ª××•× ×”</div>
        <h2>×”×“×‘×§×ª ×ª××•× ×” ×¢×œ PDF</h2>
        <div class="controls">
            <div class="control-group">
                <label>×©×§×™×¤×•×ª:</label>
                <input type="number" id="img-op" value="1" max="1" step="0.1">
            </div>
            <div class="control-group">
                <label>×’×•×“×œ (Scale):</label>
                <input type="number" id="img-scale" value="0.5" step="0.1">
            </div>
            <div class="control-group">
                <label>××™×§×•× X:</label>
                <input type="number" id="img-x" value="50">
            </div>
            <div class="control-group">
                <label>××™×§×•× Y:</label>
                <input type="number" id="img-y" value="50">
            </div>
        </div>
        <button class="btn-action" onclick="runImgOverlay()">×”×“×‘×§</button>
    </div>

    <div id="tab-protect" class="workspace">
        <div class="info-bar" id="info-protect">×‘×—×¨ ×§×•×‘×¥...</div>
        <h2>×”×’× ×” ×‘×¡×™×¡××” (Fixed)</h2>
        <div class="controls">
            <div class="control-group">
                <label>×¡×™×¡××”:</label>
                <input type="password" id="pass-val" placeholder="×”×–×Ÿ ×¡×™×¡××” ×‘×× ×’×œ×™×ª">
            </div>
        </div>
        <button class="btn-action" onclick="runProtect()">×”×¦×¤×Ÿ ×§×•×‘×¥</button>
    </div>

    <div id="tab-bw" class="workspace">
        <div class="info-bar" id="info-bw">×‘×—×¨ ×§×•×‘×¥...</div>
        <h2>×”××¨×” ×œ×©×—×•×¨ ×œ×‘×Ÿ</h2>
        <p>×ª×”×œ×™×š ×–×” ×××™×¨ ××ª ×¢××•×“×™ ×”-PDF ×œ×’×•×•× ×™ ××¤×•×¨.</p>
        <button class="btn-action" onclick="runGrayscale()">×”××¨</button>
    </div>

    <div id="status" class="status-msg"></div>

</div>

<script>
    // === ××©×ª× ×™× ===
    let fileQueue = [];
    let customFont = null;
    let visualPdfDoc = null; // ×œ×× ×™×¤×•×œ×¦×™×” ×•×™×–×•××œ×™×ª
    let visualPageOrder = []; // ××¢×§×‘ ××—×¨×™ ×”×¡×“×¨ ×”×•×™×–×•××œ×™
    const { PDFDocument, rgb, degrees, StandardFonts } = PDFLib;

    // === × ×™×”×•×œ UI ===
    function switchTab(id) {
        document.querySelectorAll('.workspace').forEach(e => e.classList.remove('active'));
        document.querySelectorAll('.nav-btn').forEach(e => e.classList.remove('active'));
        document.getElementById('tab-' + id).classList.add('active');
        event.currentTarget.classList.add('active');
        setStatus('');
        updateFileInfo(id);
    }

    function setStatus(msg, type = 'loading') {
        const el = document.getElementById('status');
        if (!msg) { el.style.display = 'none'; return; }
        el.innerText = msg;
        el.className = 'status-msg ' + type;
        el.style.display = 'block';
    }

    // === ×¢×“×›×•×Ÿ ××™×“×¢ ===
    async function updateFileInfo(tabId) {
        const infoId = 'info-' + tabId;
        const el = document.getElementById(infoId);
        if (!el) return;

        if (fileQueue.length === 0) {
            el.innerText = '×œ× × ×‘×—×¨×• ×§×‘×¦×™× (×”×•×¡×£ ×œ××¢×œ×”)';
            el.style.color = '#ef4444';
        } else {
            const f = fileQueue[0];
            // × ×™×¡×™×•×Ÿ ×œ×§×¨×•× ××¡×¤×¨ ×¢××•×“×™× ×× ×–×” PDF
            let pageCount = '?';
            if (f.type === 'application/pdf') {
                try {
                    const arrayBuffer = await f.file.arrayBuffer(); // ×§×¨×™××” ××”×™×¨×” ×¨×§ ×œ××™×“×¢
                    const pdf = await PDFDocument.load(arrayBuffer, { ignoreEncryption: true });
                    pageCount = pdf.getPageCount();
                } catch(e) { /* ×”×ª×¢×œ× ××©×’×™××•×ª ×”×¦×¤× ×” ×‘×©×œ×‘ ×”×ª×¦×•×’×” */ }
            }
            
            el.innerText = `×§×•×‘×¥: ${f.name} | ×’×•×“×œ: ${f.size} | ×¢××•×“×™×: ${pageCount}`;
            el.style.color = '#1e40af';
        }
    }

    // === × ×™×”×•×œ ×§×‘×¦×™× ===
    function addFiles(input) {
        Array.from(input.files).forEach(f => {
            fileQueue.push({
                id: Math.random().toString(36),
                file: f,
                name: f.name,
                type: f.type,
                size: (f.size / 1024 / 1024).toFixed(2) + 'MB'
            });
        });
        renderFiles();
        input.value = '';
        // ×¢×“×›×•×Ÿ ×”××™×“×¢ ×‘×˜××‘ ×”×¤×¢×™×œ
        const activeTab = document.querySelector('.workspace.active');
        if(activeTab) updateFileInfo(activeTab.id.replace('tab-', ''));
    }

    function removeFile(id) {
        fileQueue = fileQueue.filter(f => f.id !== id);
        renderFiles();
    }

    function clearFiles() {
        fileQueue = [];
        renderFiles();
        document.getElementById('visual-grid').innerHTML = ''; // × ×™×§×•×™ ×•×™×–×•××œ×™
    }

    function renderFiles() {
        const list = document.getElementById('file-list');
        list.innerHTML = '';
        if (fileQueue.length === 0) {
            list.innerHTML = '<li style="text-align:center; color:#999; padding:20px;">×”×¨×©×™××” ×¨×™×§×”...</li>';
            return;
        }
        fileQueue.forEach((f, i) => {
            const li = document.createElement('li');
            li.className = 'file-item';
            li.setAttribute('data-id', f.id);
            li.innerHTML = `
                <div><strong>${i + 1}. ${f.name}</strong> <span style="font-size:0.8em; color:#64748b">(${f.size})</span></div>
                <button onclick="removeFile('${f.id}')" style="background:none; border:none; cursor:pointer;">âŒ</button>
            `;
            list.appendChild(li);
        });
    }

    // ×’×¨×™×¨×” ×‘×¨×©×™××ª ×”×§×‘×¦×™×
    new Sortable(document.getElementById('file-list'), {
        animation: 150,
        onEnd: () => {
            const newOrder = [];
            document.querySelectorAll('.file-item').forEach(el => {
                newOrder.push(fileQueue.find(f => f.id === el.getAttribute('data-id')));
            });
            fileQueue = newOrder;
            renderFiles();
        }
    });

    // ×¤×•× ×˜
    function loadFont(input) {
        const file = input.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (e) => {
            customFont = e.target.result;
            document.getElementById('font-status').innerText = 'âœ… × ×˜×¢×Ÿ: ' + file.name;
            document.getElementById('font-status').style.color = '#16a34a';
        };
        reader.readAsArrayBuffer(file);
    }

    function downloadBlob(blob, name) {
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = name;
        a.click();
        URL.revokeObjectURL(url);
    }

    // ============================================
    //              ×¢×•×¨×š ×•×™×–×•××œ×™ (×—×“×©!)
    // ============================================
    
    async function loadVisualEditor() {
        if (!fileQueue.length || fileQueue[0].type !== 'application/pdf') return alert('×‘×—×¨ ×§×•×‘×¥ PDF ×¨××©×•×Ÿ ×‘×¨×©×™××”');
        
        setStatus('×˜×•×¢×Ÿ ×ª×¦×•×’×” ××§×“×™××”...');
        const grid = document.getElementById('visual-grid');
        grid.innerHTML = '';
        visualPageOrder = [];

        try {
            const bytes = await fileQueue[0].file.arrayBuffer();
            visualPdfDoc = await PDFDocument.load(bytes); // ×œ×©×™××•×© ×‘×©×™× ×•×™×™×
            
            // ×©×™××•×© ×‘-PDF.js ×œ×¨×™× ×“×•×¨ ×ª××•× ×•×ª
            const loadingTask = pdfjsLib.getDocument(bytes);
            const pdf = await loadingTask.promise;
            
            for(let i=1; i<=pdf.numPages; i++) {
                const page = await pdf.getPage(i);
                const viewport = page.getViewport({ scale: 0.3 }); // ×ª××•× ×” ×§×˜× ×”
                
                const div = document.createElement('div');
                div.className = 'page-thumb';
                div.setAttribute('data-original-index', i - 1); // ××™× ×“×§×¡ 0-based
                div.onclick = () => div.classList.toggle('selected');
                
                const canvas = document.createElement('canvas');
                canvas.height = viewport.height;
                canvas.width = viewport.width;
                
                await page.render({ canvasContext: canvas.getContext('2d'), viewport }).promise;
                
                div.appendChild(canvas);
                div.innerHTML += `<div class="page-number">${i}</div>`;
                grid.appendChild(div);
                visualPageOrder.push(i-1);
            }
            
            // ××¤×©×•×¨ ×’×¨×™×¨×” ×‘×¢×•×¨×š ×”×•×™×–×•××œ×™
            new Sortable(grid, { animation: 150 });
            setStatus('âœ… ×”×ª×¦×•×’×” × ×˜×¢× ×”. × ×™×ª×Ÿ ×œ×’×¨×•×¨ ×•×œ×¡××Ÿ.', 'success');

        } catch(e) { setStatus('×©×’×™××” ×‘×˜×¢×™× ×”: ' + e.message, 'error'); }
    }

    function deleteSelectedPages() {
        const selected = document.querySelectorAll('.page-thumb.selected');
        if(selected.length === 0) return alert('×œ× × ×‘×—×¨×• ×¢××•×“×™×');
        selected.forEach(el => el.remove()); // ×”×¡×¨×” ××”×ª×¦×•×’×” (×”×©××™×¨×” ×ª×ª×‘×¦×¢ ×œ×¤×™ ×”-DOM)
    }

    async function saveVisualChanges() {
        if(!visualPdfDoc) return alert('×§×•×“× ×˜×¢×Ÿ ×ª×¦×•×’×”');
        setStatus('×©×•××¨ ×©×™× ×•×™×™×...');
        
        try {
            const newPdf = await PDFDocument.create();
            // ×§×¨×™××ª ×”×¡×“×¨ ×”×—×“×© ××”-DOM
            const thumbs = document.querySelectorAll('.page-thumb');
            const indices = Array.from(thumbs).map(el => parseInt(el.getAttribute('data-original-index')));
            
            const copiedPages = await newPdf.copyPages(visualPdfDoc, indices);
            copiedPages.forEach(p => newPdf.addPage(p));
            
            downloadBlob(new Blob([await newPdf.save()], {type:'application/pdf'}), 'edited_visual.pdf');
            setStatus('âœ… × ×©××¨ ×‘×”×¦×œ×—×”!', 'success');
        } catch(e) { setStatus('×©×’×™××” ×‘×©××™×¨×”: ' + e.message, 'error'); }
    }


    // ============================================
    //              ×©××¨ ×”×¤×•× ×§×¦×™×•×ª
    // ============================================

    // 1. ××™×—×•×“
    async function runMerge() {
        if (!fileQueue.length) return alert('××™×Ÿ ×§×‘×¦×™×');
        setStatus('×××—×“...');
        try {
            const doc = await PDFDocument.create();
            for (const item of fileQueue) {
                const bytes = await item.file.arrayBuffer();
                if (item.type === 'application/pdf') {
                    const src = await PDFDocument.load(bytes);
                    const pages = await doc.copyPages(src, src.getPageIndices());
                    pages.forEach(p => doc.addPage(p));
                } else if (item.type.includes('image')) {
                    let img;
                    if (item.type.includes('png')) img = await doc.embedPng(bytes);
                    else img = await doc.embedJpg(bytes);
                    const p = doc.addPage([img.width, img.height]);
                    p.drawImage(img, { x: 0, y: 0, width: img.width, height: img.height });
                }
            }
            downloadBlob(new Blob([await doc.save()], { type: 'application/pdf' }), 'merged.pdf');
            setStatus('âœ… ×‘×•×¦×¢!', 'success');
        } catch (e) { setStatus('×©×’×™××”: ' + e.message, 'error'); }
    }

    // 2. ×¤×™×¦×•×œ
    async function runSplit() {
        if (!fileQueue.length) return alert('×‘×—×¨ ×§×•×‘×¥');
        const mode = document.getElementById('split-mode').value;
        setStatus('××¤×¦×œ...');
        try {
            const bytes = await fileQueue[0].file.arrayBuffer();
            const src = await PDFDocument.load(bytes);
            
            if (mode === 'zip') {
                const zip = new JSZip();
                for (let i = 0; i < src.getPageCount(); i++) {
                    const newDoc = await PDFDocument.create();
                    const [p] = await newDoc.copyPages(src, [i]);
                    newDoc.addPage(p);
                    zip.file(`page_${i + 1}.pdf`, await newDoc.save());
                }
                const content = await zip.generateAsync({ type: "blob" });
                downloadBlob(content, "split_files.zip");
            } else {
                const rangeStr = document.getElementById('split-range').value;
                const parts = rangeStr.split('-');
                let start = parseInt(parts[0]) - 1;
                let end = parseInt(parts[1]) - 1;
                if (isNaN(start)) throw new Error('×˜×•×•×— ×œ× ×ª×§×™×Ÿ');
                
                const newDoc = await PDFDocument.create();
                const indices = [];
                for(let i=start; i<=end; i++) indices.push(i);
                
                const pages = await newDoc.copyPages(src, indices);
                pages.forEach(p => newDoc.addPage(p));
                downloadBlob(new Blob([await newDoc.save()], {type:'application/pdf'}), 'split.pdf');
            }
            setStatus('âœ… ×‘×•×¦×¢!', 'success');
        } catch (e) { setStatus('×©×’×™××”: ' + e.message, 'error'); }
    }

    // 3. ×˜×§×¡×˜
    async function runAddText() {
        if (!fileQueue.length) return alert('×‘×—×¨ ×§×•×‘×¥');
        if (!customFont) return alert('×—×•×‘×” ×œ×˜×¢×•×Ÿ ×¤×•× ×˜!');
        setStatus('××•×¡×™×£ ×˜×§×¡×˜...');
        try {
            const doc = await PDFDocument.load(await fileQueue[0].file.arrayBuffer());
            doc.registerFontkit(fontkit);
            const font = await doc.embedFont(customFont);
            
            const text = document.getElementById('txt-val').value.split('').reverse().join('');
            const size = parseInt(document.getElementById('txt-size').value);
            const colorHex = document.getElementById('txt-color').value;
            const pos = document.getElementById('txt-pos').value;
            const rgbColor = hexToRgb(colorHex);

            doc.getPages().forEach(p => {
                const {width, height} = p.getSize();
                let x=50, y=50;
                if(pos.includes('top')) y = height - 50;
                if(pos.includes('center')) { x = width/2; y = height/2; }
                if(pos.includes('right')) x = width - 200;
                
                p.drawText(text, { x, y, size, font, color: rgbColor });
            });
            downloadBlob(new Blob([await doc.save()], { type: 'application/pdf' }), 'text.pdf');
            setStatus('âœ… ×‘×•×¦×¢!', 'success');
        } catch (e) { setStatus('×©×’×™××”: ' + e.message, 'error'); }
    }

    // 4. ×—×•×ª××ª ××™×
    async function runWatermark() {
        if (!fileQueue.length) return alert('×‘×—×¨ ×§×•×‘×¥');
        setStatus('××•×¡×™×£ ×—×•×ª××ª...');
        try {
            const doc = await PDFDocument.load(await fileQueue[0].file.arrayBuffer());
            doc.registerFontkit(fontkit);
            let font = customFont ? await doc.embedFont(customFont) : await doc.embedFont(StandardFonts.Helvetica);
            
            const text = document.getElementById('wm-text').value.split('').reverse().join('');
            const angle = parseInt(document.getElementById('wm-angle').value);
            const size = parseInt(document.getElementById('wm-size').value);
            const op = parseFloat(document.getElementById('wm-op').value);
            const rgbColor = hexToRgb(document.getElementById('wm-color').value);

            doc.getPages().forEach(p => {
                const { width, height } = p.getSize();
                p.drawText(text, {
                    x: width / 2 - (size*2),
                    y: height / 2,
                    size: size,
                    font: font,
                    color: rgbColor,
                    opacity: op,
                    rotate: degrees(angle)
                });
            });
            downloadBlob(new Blob([await doc.save()], { type: 'application/pdf' }), 'watermark.pdf');
            setStatus('âœ… ×‘×•×¦×¢!', 'success');
        } catch (e) { setStatus('×©×’×™××”: ' + e.message, 'error'); }
    }

    // 5. ××¡×¤×•×¨
    async function runPageNum() {
        if (!fileQueue.length) return alert('×‘×—×¨ ×§×•×‘×¥');
        setStatus('×××¡×¤×¨...');
        try {
            const doc = await PDFDocument.load(await fileQueue[0].file.arrayBuffer());
            doc.registerFontkit(fontkit);
            let font = customFont ? await doc.embedFont(customFont) : await doc.embedFont(StandardFonts.Helvetica);
            
            const fmt = document.getElementById('pg-fmt').value;
            const pos = document.getElementById('pg-pos').value;
            const color = hexToRgb(document.getElementById('pg-color').value);
            const total = doc.getPageCount();

            doc.getPages().forEach((p, i) => {
                const { width, height } = p.getSize();
                let txt = `${i + 1}`;
                if (fmt === 'eng') txt = `Page ${i + 1} of ${total}`;
                if (fmt === 'heb') txt = `×¢××•×“ ${i + 1} ××ª×•×š ${total}`.split('').reverse().join('');

                let x=width/2-10, y=20;
                if(pos==='top') y = height - 20;
                if(pos==='bottom-side') x = width - 50;

                p.drawText(txt, { x, y, size: 12, font, color });
            });
            downloadBlob(new Blob([await doc.save()], { type: 'application/pdf' }), 'numbered.pdf');
            setStatus('âœ… ×‘×•×¦×¢!', 'success');
        } catch (e) { setStatus('×©×’×™××”: ' + e.message, 'error'); }
    }

    // 6. ×”××¨×” ×œ×ª××•× ×•×ª
    async function runConvertToImages() {
        if (!fileQueue.length) return alert('×‘×—×¨ ×§×•×‘×¥');
        setStatus('×××™×¨ ×œ×ª××•× ×•×ª... (×¡×‘×œ× ×•×ª)');
        try {
            const bytes = await fileQueue[0].file.arrayBuffer();
            const pdf = await pdfjsLib.getDocument(bytes).promise;
            const zip = new JSZip();
            const fmt = document.getElementById('conv-fmt').value;

            for (let i = 1; i <= pdf.numPages; i++) {
                const page = await pdf.getPage(i);
                const viewport = page.getViewport({ scale: 2 });
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                canvas.width = viewport.width;
                canvas.height = viewport.height;
                await page.render({ canvasContext: ctx, viewport }).promise;
                
                const imgData = canvas.toDataURL(`image/${fmt}`, 0.8);
                zip.file(`page_${i}.${fmt}`, imgData.split(',')[1], { base64: true });
            }
            const content = await zip.generateAsync({ type: "blob" });
            downloadBlob(content, "images.zip");
            setStatus('âœ… ×”×•×©×œ×!', 'success');
        } catch (e) { setStatus('×©×’×™××”: ' + e.message, 'error'); }
    }

    // 7. ×ª××•× ×” ×œ-PDF
    async function runImgOverlay() {
        if (fileQueue.length < 2) return alert('× ×“×¨×©: ×§×•×‘×¥ PDF ×¨××©×•×Ÿ, ×ª××•× ×” ×©× ×™×™×”');
        setStatus('××“×‘×™×§...');
        try {
            const doc = await PDFDocument.load(await fileQueue[0].file.arrayBuffer());
            const imgBytes = await fileQueue[1].file.arrayBuffer();
            let img;
            if(fileQueue[1].type.includes('png')) img = await doc.embedPng(imgBytes);
            else img = await doc.embedJpg(imgBytes);

            const scale = parseFloat(document.getElementById('img-scale').value);
            const op = parseFloat(document.getElementById('img-op').value);
            const x = parseFloat(document.getElementById('img-x').value);
            const y = parseFloat(document.getElementById('img-y').value);
            const dims = img.scale(scale);

            doc.getPages()[0].drawImage(img, { x, y, width: dims.width, height: dims.height, opacity: op });
            downloadBlob(new Blob([await doc.save()], { type: 'application/pdf' }), 'overlay.pdf');
            setStatus('âœ… ×‘×•×¦×¢!', 'success');
        } catch (e) { setStatus('×©×’×™××”: ' + e.message, 'error'); }
    }

    // 8. ×”×¦×¤× ×” (××ª×•×§×Ÿ)
    async function runProtect() {
        if (!fileQueue.length) return alert('×‘×—×¨ ×§×•×‘×¥');
        const pass = document.getElementById('pass-val').value;
        if (!pass) return alert('×”×–×Ÿ ×¡×™×¡××”');
        
        setStatus('××¦×¤×™×Ÿ...');
        try {
            const doc = await PDFDocument.load(await fileQueue[0].file.arrayBuffer());
            doc.encrypt({
                userPassword: pass,
                ownerPassword: pass,
                permissions: { printing: 'highResolution', modifying: false, copying: false }
            });
            downloadBlob(new Blob([await doc.save()], { type: 'application/pdf' }), 'protected.pdf');
            setStatus('âœ… ×”×•×¦×¤×Ÿ ×‘×”×¦×œ×—×”!', 'success');
        } catch (e) { setStatus('×©×’×™××”: ' + e.message, 'error'); }
    }

    // 9. ×©×—×•×¨ ×œ×‘×Ÿ
    async function runGrayscale() {
        if (!fileQueue.length) return alert('×‘×—×¨ ×§×•×‘×¥');
        setStatus('×××™×¨ ×œ×©×—×•×¨ ×œ×‘×Ÿ...');
        try {
            const bytes = await fileQueue[0].file.arrayBuffer();
            const pdf = await pdfjsLib.getDocument(bytes).promise;
            const newDoc = await PDFDocument.create();

            for (let i = 1; i <= pdf.numPages; i++) {
                const page = await pdf.getPage(i);
                const viewport = page.getViewport({ scale: 1.5 });
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                canvas.width = viewport.width;
                canvas.height = viewport.height;
                await page.render({ canvasContext: ctx, viewport }).promise;

                const imgData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                const data = imgData.data;
                for (let j = 0; j < data.length; j += 4) {
                    const avg = (data[j] + data[j + 1] + data[j + 2]) / 3;
                    data[j] = avg; data[j + 1] = avg; data[j + 2] = avg;
                }
                ctx.putImageData(imgData, 0, 0);

                const imgUrl = canvas.toDataURL('image/jpeg', 0.7);
                const imgB = await fetch(imgUrl).then(r => r.arrayBuffer());
                const emb = await newDoc.embedJpg(imgB);
                const p = newDoc.addPage([emb.width, emb.height]);
                p.drawImage(emb, { x: 0, y: 0, width: emb.width, height: emb.height });
            }
            downloadBlob(new Blob([await newDoc.save()], { type: 'application/pdf' }), 'bw.pdf');
            setStatus('âœ… ×‘×•×¦×¢!', 'success');
        } catch (e) { setStatus('×©×’×™××”: ' + e.message, 'error'); }
    }

    function hexToRgb(hex) {
        const r = parseInt(hex.slice(1, 3), 16) / 255;
        const g = parseInt(hex.slice(3, 5), 16) / 255;
        const b = parseInt(hex.slice(5, 7), 16) / 255;
        return { type: 'RGB', red: r, green: g, blue: b }; // ×©×™××•×© ×‘××•×‘×™×™×§×˜ ×¤× ×™××™ ×©×œ PDFLib ×× ×¦×¨×™×š, ××• ×¤×©×•×˜ rgb()
    }
</script>
</body>
</html>
