<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDF PRO MAX - ×”××¢×¨×›×ª ×”××œ××”</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://unpkg.com/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
    <script src="https://unpkg.com/@pdf-lib/fontkit/dist/fontkit.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.14.0/Sortable.min.js"></script>

    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    </script>

    <style>
        :root {
            --primary: #4338ca;
            --bg: #f3f4f6;
            --card: #ffffff;
            --text: #111827;
            --border: #e5e7eb;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg);
            color: var(--text);
            margin: 0;
            padding: 20px;
            direction: rtl;
        }

        .container { max-width: 1100px; margin: 0 auto; }
        h1 { text-align: center; color: var(--primary); margin-bottom: 20px; }

        /* ×ª×¤×¨×™×˜ */
        .nav-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(130px, 1fr));
            gap: 10px;
            margin-bottom: 20px;
        }

        .nav-btn {
            background: white;
            border: 1px solid #ddd;
            padding: 15px;
            text-align: center;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
            transition: 0.2s;
        }

        .nav-btn:hover { background: #e0e7ff; border-color: var(--primary); }
        .nav-btn.active { background: var(--primary); color: white; border-color: var(--primary); }
        .nav-btn span { font-size: 1.5em; }

        /* × ×™×”×•×œ ×§×‘×¦×™× */
        .file-manager {
            background: white;
            border: 2px dashed #94a3b8;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .file-list {
            list-style: none;
            padding: 0;
            max-height: 200px;
            overflow-y: auto;
        }

        .file-item {
            background: #f1f5f9;
            border: 1px solid #cbd5e1;
            margin: 5px 0;
            padding: 8px 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-radius: 6px;
            cursor: move;
            font-size: 0.9em;
        }

        .btn-add {
            background: #059669;
            color: white;
            padding: 8px 15px;
            border-radius: 6px;
            cursor: pointer;
            display: inline-block;
            font-weight: bold;
        }

        /* ××–×•×¨×™ ×¢×‘×•×“×” */
        .workspace { display: none; background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
        .workspace.active { display: block; }

        .file-info-bar {
            background: #eff6ff;
            border: 1px solid #bfdbfe;
            color: #1e40af;
            padding: 10px;
            border-radius: 6px;
            margin-bottom: 15px;
            font-size: 0.9em;
            display: flex;
            justify-content: space-between;
        }

        /* ×¤×§×“×™× */
        .control-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }

        .control-item { display: flex; flex-direction: column; gap: 5px; }
        
        label { font-weight: bold; font-size: 0.9em; }
        input, select { padding: 10px; border: 1px solid #ccc; border-radius: 6px; }

        .btn-action {
            background: var(--primary);
            color: white;
            width: 100%;
            padding: 15px;
            border: none;
            border-radius: 8px;
            font-size: 1.1em;
            font-weight: bold;
            cursor: pointer;
            margin-top: 10px;
        }
        .btn-action:hover { opacity: 0.9; }

        .status-box { margin-top: 15px; padding: 15px; border-radius: 8px; text-align: center; display: none; font-weight: bold; }
        .status-box.loading { background: #fff7ed; color: #9a3412; }
        .status-box.success { background: #f0fdf4; color: #166534; }
        .status-box.error { background: #fef2f2; color: #991b1b; }

        .font-alert {
            background: #fffbeb;
            border: 1px solid #fcd34d;
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 15px;
            font-size: 0.9em;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
    </style>
</head>
<body>

<div class="container">
    <h1>PDF PRO MAX ğŸ› ï¸</h1>

    <div class="nav-grid">
        <div class="nav-btn active" onclick="showTab('merge')"><span>ğŸ”—</span>××™×—×•×“</div>
        <div class="nav-btn" onclick="showTab('split')"><span>âœ‚ï¸</span>×¤×™×¦×•×œ</div>
        <div class="nav-btn" onclick="showTab('text')"><span>âœï¸</span>×˜×§×¡×˜</div>
        <div class="nav-btn" onclick="showTab('watermark')"><span>ğŸ’§</span>×—×•×ª××ª</div>
        <div class="nav-btn" onclick="showTab('pagenum')"><span>ğŸ”¢</span>××¡×¤×•×¨</div>
        <div class="nav-btn" onclick="showTab('convert')"><span>ğŸ–¼ï¸</span>×”××¨×” ×œ-IMG</div>
        <div class="nav-btn" onclick="showTab('img-pdf')"><span>ğŸ“·</span>×ª××•× ×” ×œ-PDF</div>
        <div class="nav-btn" onclick="showTab('protect')"><span>ğŸ”’</span>×”×¦×¤× ×”</div>
        <div class="nav-btn" onclick="showTab('bw')"><span>âš«</span>×©×—×•×¨ ×œ×‘×Ÿ</div>
    </div>

    <div class="file-manager">
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <h3>ğŸ“‚ ×”×§×‘×¦×™× ×©×œ×š (×’×¨×•×¨ ×œ×©×™× ×•×™ ×¡×“×¨)</h3>
            <label class="btn-add">
                + ×”×•×¡×£ ×§×‘×¦×™×
                <input type="file" multiple accept=".pdf,.jpg,.png,.jpeg" style="display:none" onchange="addFiles(this)">
            </label>
        </div>
        <ul id="file-list" class="file-list">
            <li style="text-align:center; color:#999; padding:20px;">×”×¨×©×™××” ×¨×™×§×”... ×”×•×¡×£ ×§×‘×¦×™× ×›×“×™ ×œ×”×ª×—×™×œ</li>
        </ul>
        <div style="text-align: left; margin-top: 10px;">
            <button onclick="clearFiles()" style="color:red; background:none; border:none; cursor:pointer;">× ×§×” ×”×›×œ</button>
        </div>
    </div>

    <div class="font-alert">
        <div>
            <b>×—×•×‘×” ×œ×¢×‘×¨×™×ª!</b> ×œ×× ×™×¢×ª ×’'×™×‘×¨×™×© (WinAnsi), ×˜×¢×Ÿ ×§×•×‘×¥ ×¤×•× ×˜ (ttf) ××”××—×©×‘.
        </div>
        <div>
            <input type="file" accept=".ttf,.otf" onchange="loadFont(this)">
            <span id="font-status" style="margin-right:5px; font-weight:bold; color:red;">×œ× × ×˜×¢×Ÿ</span>
        </div>
    </div>

    <div id="tab-merge" class="workspace active">
        <div class="file-info-bar">×××ª×™×Ÿ ×œ×¤×¢×•×œ×” ×¢×œ ×›×œ ×”×§×‘×¦×™× ×‘×¨×©×™××”</div>
        <h2>××™×—×•×“ ×§×‘×¦×™× (PDF + ×ª××•× ×•×ª)</h2>
        <p>×”××¢×¨×›×ª ×ª×—×‘×¨ ××ª ×›×œ ×”×§×‘×¦×™× ×‘×¨×©×™××” ×œ×§×•×‘×¥ PDF ××—×“ ××¨×•×š.</p>
        <button class="btn-action" onclick="runMerge()">×‘×¦×¢ ××™×—×•×“ ×•×”×•×¨×“</button>
    </div>

    <div id="tab-split" class="workspace">
        <div class="file-info-bar" id="info-split">×‘×—×¨ ×§×•×‘×¥...</div>
        <h2>×¤×™×¦×•×œ PDF</h2>
        <div class="control-grid">
            <div class="control-item">
                <label>×¡×•×’ ×¤×™×¦×•×œ:</label>
                <select id="split-mode" onchange="toggleSplitInputs()">
                    <option value="zip">×›×œ ×”×¢××•×“×™× ×œ×§×‘×¦×™× × ×¤×¨×“×™× (ZIP)</option>
                    <option value="range">×˜×•×•×— ×¢××•×“×™× (×œ××©×œ 1-5)</option>
                </select>
            </div>
            <div class="control-item" id="split-range-box" style="display:none;">
                <label>×˜×•×•×— (×œ××©×œ 1-5, ××• 1,3,5):</label>
                <input type="text" id="split-range" placeholder="1-5">
            </div>
        </div>
        <button class="btn-action" onclick="runSplit()">×‘×¦×¢ ×¤×™×¦×•×œ</button>
    </div>

    <div id="tab-text" class="workspace">
        <div class="file-info-bar" id="info-text">×‘×—×¨ ×§×•×‘×¥...</div>
        <h2>×”×•×¡×¤×ª ×˜×§×¡×˜</h2>
        <div class="control-grid">
            <div class="control-item">
                <label>×˜×§×¡×˜:</label>
                <input type="text" id="txt-val" placeholder="×”×˜×§×¡×˜ ×©×œ×š">
            </div>
            <div class="control-item">
                <label>×’×•×“×œ:</label>
                <input type="number" id="txt-size" value="24">
            </div>
            <div class="control-item">
                <label>×¦×‘×¢:</label>
                <input type="color" id="txt-color" value="#000000" style="height:42px;">
            </div>
            <div class="control-item">
                <label>××™×§×•×:</label>
                <select id="txt-pos">
                    <option value="top-right">×œ××¢×œ×” ××™××™×Ÿ</option>
                    <option value="top-left">×œ××¢×œ×” ××©×××œ</option>
                    <option value="center">××¨×›×–</option>
                    <option value="bottom-center">×œ××˜×” ×‘×××¦×¢</option>
                </select>
            </div>
        </div>
        <button class="btn-action" onclick="runAddText()">×”×•×¡×£ ×˜×§×¡×˜</button>
    </div>

    <div id="tab-watermark" class="workspace">
        <div class="file-info-bar" id="info-watermark">×‘×—×¨ ×§×•×‘×¥...</div>
        <h2>×—×•×ª××ª ××™× (×”×—×–×¨×ª×™ ××ª ×›×œ ×”××•×¤×¦×™×•×ª!)</h2>
        <div class="control-grid">
            <div class="control-item">
                <label>×˜×§×¡×˜ ×”×—×•×ª××ª:</label>
                <input type="text" id="wm-val" placeholder="×˜×™×•×˜×” / ×¡×•×“×™">
            </div>
            <div class="control-item">
                <label>×–×•×•×™×ª (××¢×œ×•×ª):</label>
                <input type="number" id="wm-angle" value="45" placeholder="45 ×œ××œ×›×¡×•×Ÿ">
            </div>
            <div class="control-item">
                <label>×’×•×“×œ ×’×•×¤×Ÿ:</label>
                <input type="number" id="wm-size" value="60">
            </div>
            <div class="control-item">
                <label>×©×§×™×¤×•×ª (0.1 ×¢×“ 1):</label>
                <input type="number" id="wm-op" value="0.3" step="0.1" max="1" min="0.1">
            </div>
            <div class="control-item">
                <label>×¦×‘×¢:</label>
                <input type="color" id="wm-color" value="#888888" style="height:42px;">
            </div>
        </div>
        <button class="btn-action" onclick="runWatermark()">×”×•×¡×£ ×—×•×ª××ª</button>
    </div>

    <div id="tab-pagenum" class="workspace">
        <div class="file-info-bar" id="info-pagenum">×‘×—×¨ ×§×•×‘×¥...</div>
        <h2>××¡×¤×•×¨ ×¢××•×“×™×</h2>
        <div class="control-grid">
            <div class="control-item">
                <label>×¤×•×¨××˜:</label>
                <select id="pg-fmt">
                    <option value="num">1, 2, 3</option>
                    <option value="eng">Page 1 of 10</option>
                    <option value="heb">×¢××•×“ 1 ××ª×•×š 10</option>
                </select>
            </div>
            <div class="control-item">
                <label>××™×§×•×:</label>
                <select id="pg-pos">
                    <option value="bottom">×œ××˜×” ×‘×××¦×¢</option>
                    <option value="top">×œ××¢×œ×” ×‘×××¦×¢</option>
                    <option value="bottom-side">×œ××˜×” ×‘×¦×“</option>
                </select>
            </div>
            <div class="control-item">
                <label>×’×•×“×œ:</label>
                <input type="number" id="pg-size" value="12">
            </div>
            <div class="control-item">
                <label>×¦×‘×¢:</label>
                <input type="color" id="pg-color" value="#000000" style="height:42px;">
            </div>
        </div>
        <button class="btn-action" onclick="runPageNum()">×”×•×¡×£ ××¡×¤×•×¨</button>
    </div>

    <div id="tab-convert" class="workspace">
        <div class="file-info-bar" id="info-convert">×‘×—×¨ ×§×•×‘×¥...</div>
        <h2>×”××¨×ª PDF ×œ×ª××•× ×•×ª (ZIP)</h2>
        <div class="control-grid">
            <div class="control-item">
                <label>×¤×•×¨××˜:</label>
                <select id="conv-fmt">
                    <option value="jpeg">JPEG (×§×œ ××©×§×œ)</option>
                    <option value="png">PNG (××™×›×•×ª ×’×‘×•×”×”)</option>
                </select>
            </div>
        </div>
        <button class="btn-action" onclick="runConvertToImages()">×”××¨ ×•×”×•×¨×“ ZIP</button>
    </div>

    <div id="tab-img-pdf" class="workspace">
        <div class="file-info-bar">×”×§×•×‘×¥ ×”-1: PDF, ×”×§×•×‘×¥ ×”-2: ×ª××•× ×”</div>
        <h2>×”×“×‘×§×ª ×ª××•× ×” ×¢×œ PDF</h2>
        <div class="control-grid">
            <div class="control-item">
                <label>×’×•×“×œ (Scale):</label>
                <input type="number" id="img-scale" value="0.5" step="0.1" placeholder="0.5 = ×—×¦×™ ×’×•×“×œ">
            </div>
            <div class="control-item">
                <label>×©×§×™×¤×•×ª:</label>
                <input type="number" id="img-op" value="1" step="0.1" max="1">
            </div>
            <div class="control-item">
                <label>××™×§×•× X:</label>
                <input type="number" id="img-x" value="50">
            </div>
            <div class="control-item">
                <label>××™×§×•× Y:</label>
                <input type="number" id="img-y" value="50">
            </div>
        </div>
        <button class="btn-action" onclick="runImgOverlay()">×”×“×‘×§ ×ª××•× ×”</button>
    </div>

    <div id="tab-protect" class="workspace">
        <div class="file-info-bar" id="info-protect">×‘×—×¨ ×§×•×‘×¥...</div>
        <h2>×”×’× ×” ×‘×¡×™×¡××”</h2>
        <input type="password" id="pass-val" placeholder="×”×–×Ÿ ×¡×™×¡××” ×—×–×§×”">
        <button class="btn-action" onclick="runProtect()">×”×¦×¤×Ÿ ×§×•×‘×¥</button>
    </div>

    <div id="tab-bw" class="workspace">
        <div class="file-info-bar" id="info-bw">×‘×—×¨ ×§×•×‘×¥...</div>
        <h2>×”××¨×” ×œ×©×—×•×¨ ×œ×‘×Ÿ</h2>
        <p>×××™×¨ ××ª ×›×œ ×¢××•×“×™ ×”-PDF ×œ×’×•×•× ×™ ××¤×•×¨.</p>
        <button class="btn-action" onclick="runGrayscale()">×‘×¦×¢ ×”××¨×”</button>
    </div>

    <div id="status" class="status-box"></div>
</div>

<script>
    // === ××©×ª× ×™× ×’×œ×•×‘×œ×™×™× ===
    let fileQueue = [];
    let customFont = null;
    const { PDFDocument, rgb, degrees, StandardFonts } = PDFLib;

    // === × ×™×”×•×œ ×××©×§ ===
    function showTab(id) {
        document.querySelectorAll('.workspace').forEach(e => e.classList.remove('active'));
        document.querySelectorAll('.nav-btn').forEach(e => e.classList.remove('active'));
        document.getElementById('tab-' + id).classList.add('active');
        event.currentTarget.classList.add('active');
        setStatus('');
        updateFileInfo(id);
    }

    function setStatus(msg, type = 'loading') {
        const el = document.getElementById('status');
        if (!msg) { el.style.display = 'none'; return; }
        el.innerHTML = msg;
        el.className = 'status-box ' + type;
        el.style.display = 'block';
    }

    function toggleSplitInputs() {
        const val = document.getElementById('split-mode').value;
        document.getElementById('split-range-box').style.display = (val === 'range') ? 'block' : 'none';
    }

    // === ×¢×“×›×•×Ÿ ××™×“×¢ ×¢×œ ×”×§×•×‘×¥ ×”× ×•×›×—×™ ===
    function updateFileInfo(tabId) {
        const infoId = 'info-' + tabId;
        const el = document.getElementById(infoId);
        if (!el) return;

        if (fileQueue.length === 0) {
            el.innerText = '×œ× × ×‘×—×¨×• ×§×‘×¦×™× (×”×•×¡×£ ×œ××¢×œ×”)';
            el.style.color = 'red';
        } else {
            const f = fileQueue[0];
            el.innerText = `×¢×•×‘×“ ×¢×œ: ${f.name} (${f.size}) - ${f.type}`;
            el.style.color = '#1e40af';
        }
    }

    // === × ×™×”×•×œ ×§×‘×¦×™× ===
    function addFiles(input) {
        Array.from(input.files).forEach(f => {
            fileQueue.push({
                id: Math.random().toString(36),
                file: f,
                name: f.name,
                type: f.type,
                size: (f.size / 1024 / 1024).toFixed(2) + ' MB'
            });
        });
        renderFiles();
        input.value = '';
        // ×¨×¢× ×•×Ÿ ×”××™×“×¢ ×‘×˜××‘ ×”×¤×¢×™×œ
        const activeTab = document.querySelector('.workspace.active');
        if (activeTab) updateFileInfo(activeTab.id.replace('tab-', ''));
    }

    function removeFile(id) {
        fileQueue = fileQueue.filter(f => f.id !== id);
        renderFiles();
    }

    function clearFiles() {
        fileQueue = [];
        renderFiles();
    }

    function renderFiles() {
        const list = document.getElementById('file-list');
        list.innerHTML = '';
        if (fileQueue.length === 0) {
            list.innerHTML = '<li style="text-align:center; color:#999; padding:20px;">×”×¨×©×™××” ×¨×™×§×”...</li>';
            return;
        }
        fileQueue.forEach((f, i) => {
            const li = document.createElement('li');
            li.className = 'file-item';
            li.setAttribute('data-id', f.id);
            li.innerHTML = `
                <div>
                    <strong>${i + 1}. ${f.name}</strong>
                    <span style="font-size:0.8em; color:#666;">(${f.size})</span>
                </div>
                <button onclick="removeFile('${f.id}')" style="color:red; background:none; border:none; cursor:pointer;">X</button>
            `;
            list.appendChild(li);
        });
    }

    // ×’×¨×™×¨×”
    new Sortable(document.getElementById('file-list'), {
        animation: 150,
        onEnd: () => {
            const newOrder = [];
            document.querySelectorAll('.file-item').forEach(el => {
                const id = el.getAttribute('data-id');
                newOrder.push(fileQueue.find(f => f.id === id));
            });
            fileQueue = newOrder;
            renderFiles();
        }
    });

    // ×¤×•× ×˜
    function loadFont(input) {
        const file = input.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (e) => {
            customFont = e.target.result;
            document.getElementById('font-status').innerText = 'âœ… ' + file.name;
            document.getElementById('font-status').style.color = 'green';
        };
        reader.readAsArrayBuffer(file);
    }

    function downloadBlob(blob, name) {
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = name;
        a.click();
        URL.revokeObjectURL(url);
    }

    // ============================================
    //              ×œ×•×’×™×§×” (Functions)
    // ============================================

    // 1. ××™×—×•×“
    async function runMerge() {
        if (!fileQueue.length) return alert('××™×Ÿ ×§×‘×¦×™×');
        setStatus('×××—×“...');
        try {
            const doc = await PDFDocument.create();
            for (const item of fileQueue) {
                const bytes = await item.file.arrayBuffer();
                if (item.type === 'application/pdf') {
                    const src = await PDFDocument.load(bytes);
                    const pages = await doc.copyPages(src, src.getPageIndices());
                    pages.forEach(p => doc.addPage(p));
                } else if (item.type.includes('image')) {
                    let img;
                    if (item.type.includes('png')) img = await doc.embedPng(bytes);
                    else img = await doc.embedJpg(bytes);
                    const p = doc.addPage([img.width, img.height]);
                    p.drawImage(img, { x: 0, y: 0, width: img.width, height: img.height });
                }
            }
            downloadBlob(new Blob([await doc.save()], { type: 'application/pdf' }), 'merged.pdf');
            setStatus('âœ… ××™×—×•×“ ×”×¦×œ×™×—!', 'success');
        } catch (e) { setStatus('×©×’×™××”: ' + e.message, 'error'); }
    }

    // 2. ×¤×™×¦×•×œ
    async function runSplit() {
        if (!fileQueue.length) return alert('×‘×—×¨ ×§×•×‘×¥');
        const mode = document.getElementById('split-mode').value;
        setStatus('××‘×¦×¢ ×¤×™×¦×•×œ...');
        
        try {
            const bytes = await fileQueue[0].file.arrayBuffer();
            const src = await PDFDocument.load(bytes);
            
            if (mode === 'zip') {
                const zip = new JSZip();
                for (let i = 0; i < src.getPageCount(); i++) {
                    const newDoc = await PDFDocument.create();
                    const [p] = await newDoc.copyPages(src, [i]);
                    newDoc.addPage(p);
                    zip.file(`page_${i + 1}.pdf`, await newDoc.save());
                }
                const content = await zip.generateAsync({ type: "blob" });
                downloadBlob(content, "split_files.zip");
            } else {
                // ×˜×•×•×—
                const rangeStr = document.getElementById('split-range').value; // "1-3"
                // ×¤×™×¢× ×•×— ×˜×•×•×— ×¤×©×•×˜ (1-3)
                const parts = rangeStr.split('-');
                let start = parseInt(parts[0]) - 1;
                let end = parseInt(parts[1]) - 1;
                
                if (isNaN(start) || isNaN(end)) throw new Error('×˜×•×•×— ×œ× ×ª×§×™×Ÿ');
                
                const newDoc = await PDFDocument.create();
                const indices = [];
                for (let i = start; i <= end; i++) indices.push(i);
                
                const pages = await newDoc.copyPages(src, indices);
                pages.forEach(p => newDoc.addPage(p));
                downloadBlob(new Blob([await newDoc.save()], {type:'application/pdf'}), 'split_range.pdf');
            }
            setStatus('âœ… ×‘×•×¦×¢!', 'success');
        } catch (e) { setStatus('×©×’×™××”: ' + e.message, 'error'); }
    }

    // 3. ×˜×§×¡×˜
    async function runAddText() {
        if (!fileQueue.length) return alert('×‘×—×¨ ×§×•×‘×¥');
        if (!customFont) return alert('×—×•×‘×” ×œ×˜×¢×•×Ÿ ×¤×•× ×˜!');
        setStatus('××•×¡×™×£ ×˜×§×¡×˜...');
        
        try {
            const doc = await PDFDocument.load(await fileQueue[0].file.arrayBuffer());
            doc.registerFontkit(fontkit);
            const font = await doc.embedFont(customFont);
            
            const text = document.getElementById('txt-val').value.split('').reverse().join('');
            const size = parseInt(document.getElementById('txt-size').value);
            const colorHex = document.getElementById('txt-color').value;
            const r = parseInt(colorHex.slice(1, 3), 16) / 255;
            const g = parseInt(colorHex.slice(3, 5), 16) / 255;
            const b = parseInt(colorHex.slice(5, 7), 16) / 255;
            const pos = document.getElementById('txt-pos').value;

            doc.getPages().forEach(p => {
                const { width, height } = p.getSize();
                let x = 50, y = 50;
                if (pos === 'top-right') { x = width - 200; y = height - 50; }
                if (pos === 'top-left') { x = 50; y = height - 50; }
                if (pos === 'center') { x = width / 2 - 50; y = height / 2; }
                if (pos === 'bottom-center') { x = width / 2 - 50; y = 50; }
                
                p.drawText(text, { x, y, size, font, color: rgb(r, g, b) });
            });
            downloadBlob(new Blob([await doc.save()], { type: 'application/pdf' }), 'text.pdf');
            setStatus('âœ… ×‘×•×¦×¢!', 'success');
        } catch (e) { setStatus('×©×’×™××”: ' + e.message, 'error'); }
    }

    // 4. ×—×•×ª××ª ××™× (×¢× ×›×œ ×”××•×¤×¦×™×•×ª)
    async function runWatermark() {
        if (!fileQueue.length) return alert('×‘×—×¨ ×§×•×‘×¥');
        setStatus('××•×¡×™×£ ×—×•×ª××ª...');
        try {
            const doc = await PDFDocument.load(await fileQueue[0].file.arrayBuffer());
            let font;
            if (customFont) {
                doc.registerFontkit(fontkit);
                font = await doc.embedFont(customFont);
            } else {
                font = await doc.embedFont(StandardFonts.Helvetica);
            }

            const text = document.getElementById('wm-val').value.split('').reverse().join('');
            const angle = parseInt(document.getElementById('wm-angle').value);
            const size = parseInt(document.getElementById('wm-size').value);
            const op = parseFloat(document.getElementById('wm-op').value);
            const colorHex = document.getElementById('wm-color').value;
            const r = parseInt(colorHex.slice(1, 3), 16) / 255;
            const g = parseInt(colorHex.slice(3, 5), 16) / 255;
            const b = parseInt(colorHex.slice(5, 7), 16) / 255;

            doc.getPages().forEach(p => {
                const { width, height } = p.getSize();
                p.drawText(text, {
                    x: width / 2 - 50,
                    y: height / 2,
                    size: size,
                    font: font,
                    color: rgb(r, g, b),
                    opacity: op,
                    rotate: degrees(angle)
                });
            });
            downloadBlob(new Blob([await doc.save()], { type: 'application/pdf' }), 'watermark.pdf');
            setStatus('âœ… ×‘×•×¦×¢!', 'success');
        } catch (e) { setStatus('×©×’×™××”: ' + e.message, 'error'); }
    }

    // 5. ××¡×¤×•×¨
    async function runPageNum() {
        if (!fileQueue.length) return alert('×‘×—×¨ ×§×•×‘×¥');
        setStatus('×××¡×¤×¨...');
        try {
            const doc = await PDFDocument.load(await fileQueue[0].file.arrayBuffer());
            let font;
            if (customFont) {
                doc.registerFontkit(fontkit);
                font = await doc.embedFont(customFont);
            } else {
                font = await doc.embedFont(StandardFonts.Helvetica);
            }

            const fmt = document.getElementById('pg-fmt').value;
            const pos = document.getElementById('pg-pos').value;
            const size = parseInt(document.getElementById('pg-size').value);
            const colorHex = document.getElementById('pg-color').value;
            const r = parseInt(colorHex.slice(1, 3), 16) / 255;
            const g = parseInt(colorHex.slice(3, 5), 16) / 255;
            const b = parseInt(colorHex.slice(5, 7), 16) / 255;
            const total = doc.getPageCount();

            doc.getPages().forEach((p, i) => {
                const { width, height } = p.getSize();
                let txt = `${i + 1}`;
                if (fmt === 'eng') txt = `Page ${i + 1} of ${total}`;
                if (fmt === 'heb') txt = `×¢××•×“ ${i + 1} ××ª×•×š ${total}`.split('').reverse().join('');

                let x, y;
                if (pos === 'bottom') { x = width / 2 - 20; y = 20; }
                if (pos === 'top') { x = width / 2 - 20; y = height - 20; }
                if (pos === 'bottom-side') { x = width - 50; y = 20; }

                p.drawText(txt, { x, y, size, font, color: rgb(r, g, b) });
            });
            downloadBlob(new Blob([await doc.save()], { type: 'application/pdf' }), 'numbered.pdf');
            setStatus('âœ… ×‘×•×¦×¢!', 'success');
        } catch (e) { setStatus('×©×’×™××”: ' + e.message, 'error'); }
    }

    // 6. ×”××¨×” ×œ×ª××•× ×•×ª
    async function runConvertToImages() {
        if (!fileQueue.length) return alert('×‘×—×¨ ×§×•×‘×¥');
        setStatus('×××™×¨ ×œ×ª××•× ×•×ª... (×¡×‘×œ× ×•×ª)');
        try {
            const bytes = await fileQueue[0].file.arrayBuffer();
            const pdf = await pdfjsLib.getDocument(bytes).promise;
            const zip = new JSZip();
            const fmt = document.getElementById('conv-fmt').value;

            for (let i = 1; i <= pdf.numPages; i++) {
                const page = await pdf.getPage(i);
                const viewport = page.getViewport({ scale: 2 });
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                canvas.width = viewport.width;
                canvas.height = viewport.height;
                await page.render({ canvasContext: ctx, viewport }).promise;
                
                const imgData = canvas.toDataURL(`image/${fmt}`, 0.8);
                zip.file(`page_${i}.${fmt}`, imgData.split(',')[1], { base64: true });
            }
            const content = await zip.generateAsync({ type: "blob" });
            downloadBlob(content, "images.zip");
            setStatus('âœ… ×”×•×©×œ×!', 'success');
        } catch (e) { setStatus('×©×’×™××”: ' + e.message, 'error'); }
    }

    // 7. ×ª××•× ×” ×¢×œ PDF
    async function runImgOverlay() {
        if (fileQueue.length < 2) return alert('×¦×¨×™×š PDF ×¨××©×•×Ÿ ×•×ª××•× ×” ×©× ×™×™×”');
        setStatus('××“×‘×™×§...');
        try {
            const doc = await PDFDocument.load(await fileQueue[0].file.arrayBuffer());
            const imgBytes = await fileQueue[1].file.arrayBuffer();
            let img;
            if (fileQueue[1].type.includes('png')) img = await doc.embedPng(imgBytes);
            else img = await doc.embedJpg(imgBytes);

            const scale = parseFloat(document.getElementById('img-scale').value);
            const op = parseFloat(document.getElementById('img-op').value);
            const xVal = parseFloat(document.getElementById('img-x').value);
            const yVal = parseFloat(document.getElementById('img-y').value);

            const dims = img.scale(scale);
            doc.getPages()[0].drawImage(img, {
                x: xVal, y: yVal,
                width: dims.width, height: dims.height,
                opacity: op
            });
            downloadBlob(new Blob([await doc.save()], { type: 'application/pdf' }), 'overlay.pdf');
            setStatus('âœ… ×‘×•×¦×¢!', 'success');
        } catch (e) { setStatus('×©×’×™××”: ' + e.message, 'error'); }
    }

    // 8. ×”×¦×¤× ×”
    async function runProtect() {
        if (!fileQueue.length) return alert('×‘×—×¨ ×§×•×‘×¥');
        const pass = document.getElementById('pass-val').value;
        if (!pass) return alert('×”×–×Ÿ ×¡×™×¡××”');
        try {
            const doc = await PDFDocument.load(await fileQueue[0].file.arrayBuffer());
            doc.encrypt({ userPassword: pass, ownerPassword: pass, permissions: { modifying: false } });
            downloadBlob(new Blob([await doc.save()], { type: 'application/pdf' }), 'protected.pdf');
            setStatus('âœ… ××•×’×Ÿ!', 'success');
        } catch (e) { setStatus(e.message, 'error'); }
    }

    // 9. ×©×—×•×¨ ×œ×‘×Ÿ
    async function runGrayscale() {
        if (!fileQueue.length) return alert('×‘×—×¨ ×§×•×‘×¥');
        setStatus('×××™×¨ ×œ×’×•×•× ×™ ××¤×•×¨...');
        try {
            const bytes = await fileQueue[0].file.arrayBuffer();
            const pdf = await pdfjsLib.getDocument(bytes).promise;
            const newDoc = await PDFDocument.create();

            for (let i = 1; i <= pdf.numPages; i++) {
                const page = await pdf.getPage(i);
                const viewport = page.getViewport({ scale: 1.5 });
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                canvas.width = viewport.width;
                canvas.height = viewport.height;
                await page.render({ canvasContext: ctx, viewport }).promise;

                // ×¤×™×§×¡×œ×™×
                const imgData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                const data = imgData.data;
                for (let j = 0; j < data.length; j += 4) {
                    const avg = (data[j] + data[j + 1] + data[j + 2]) / 3;
                    data[j] = avg; data[j + 1] = avg; data[j + 2] = avg;
                }
                ctx.putImageData(imgData, 0, 0);

                const imgUrl = canvas.toDataURL('image/jpeg', 0.7);
                const imgB = await fetch(imgUrl).then(r => r.arrayBuffer());
                const emb = await newDoc.embedJpg(imgB);
                const p = newDoc.addPage([emb.width, emb.height]);
                p.drawImage(emb, { x: 0, y: 0, width: emb.width, height: emb.height });
            }
            downloadBlob(new Blob([await newDoc.save()], { type: 'application/pdf' }), 'bw.pdf');
            setStatus('âœ… ×‘×•×¦×¢!', 'success');
        } catch (e) { setStatus(e.message, 'error'); }
    }

</script>
</body>
</html>

